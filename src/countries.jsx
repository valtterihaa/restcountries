import React from 'react';
import axios from 'axios';
import {Link} from 'react-router-dom';


export class Countries extends React.Component {
    constructor(props){
        super(props);
        this.state = {
            filter:'',
            region:'',
            subr:'',
            subreg:[],
            countries:[],
            sortOrder:'name',
            sortByLow:true,
        }
    }

    componentDidMount(){
        axios.get('https://restcountries.eu/rest/v2/all')
            .then((res) => {
                this.setState({
                    countries:res.data,
                    subreg:res.data.map(d => {
                        return d.subregion
                    })
                })
            })
            .catch((err) => {
                console.log(err)
            })
    }

    textChanged(ev){
        console.log(ev.target.value);
        if (ev.target.value === 'population higher') {
            this.setState({sortByLow:false})
            this.setState({sortOrder:'population'})
        } else {
            this.setState({sortByLow:true});
            this.setState({[ev.target.id]:ev.target.value});
        }
    }

    render(){
        
        let {filter,sortOrder,subr,sortByLow} = this.state;
        let subs = Array.from(new Set(this.state.subreg))
        let subregions = subs.filter(Boolean);
        let srfilter = subregions.map(sr => {
            return <option key={sr}>{sr}</option>
        })
        let filtered = this.state.countries.filter(
            c => 
            c.name.toLowerCase().includes(filter.toLowerCase())
            &&
            c.subregion.toLowerCase().includes(subr.toLowerCase())
        );
        if (sortOrder === 'name' || sortOrder === 'region') filtered.sort((a,b) => a[sortOrder].localeCompare(b[sortOrder]));
        if (sortOrder === 'population' && sortByLow===true) {
            filtered.sort((a,b) => a[sortOrder]-b[sortOrder])
        }
        if (sortOrder === 'population' && sortByLow===false) {
            filtered.sort((a,b) => b[sortOrder]-a[sortOrder])
        }
            
        let countryInfos = filtered.map(c => 
            {
                let pop = c.population.toLocaleString();
                return (
                    <div key={c.alpha3Code} className="country-card">
                        <img src={c.flag} alt={`The flag of ${c.name}`} />
                        <div className="country-info-wrapper">
                            <div className="country-info">
                                <h2>{c.name}</h2>
                                <h3>{c.region}</h3>
                                <h3>{pop}</h3>
                            </div>
                            <div className="learn-more-wrapper">
                                <Link to={c.alpha3Code}>
                                    <div className="learn-more">Learn More</div>
                                </Link>
                            </div>
                        </div>
                    </div>
                )
            }
        );


        // Main return
        return (
            <main>
                <div className="country-filters">
                    <div>
                        <select name="sortOrder" id="sortOrder" className="country-filter" value={this.state.sortOrder} onChange={ev => this.textChanged(ev)}>
                            <option value="name">Name</option>
                            <option value="population">Population (lowest first)</option>
                            <option value="population higher">Population (highest first)</option>
                            <option value="region">Region</option>
                        </select>
                    </div>
                    <div>
                        <select name="subr" id="subr" className="country-filter" value={this.state.subr} onChange={ev => this.textChanged(ev)} >
                            <option value="">Subregion</option>
                            {srfilter}
                        </select>
                    </div>
                    <div>
                        <label htmlFor="filter" className="hide">Filter by name</label>
                        <input id="filter" className="country-filter" value={this.state.filter} onChange={ev => this.textChanged(ev)} placeholder="filter by name" />
                    </div>
                    

                </div>
                <div className="all-countries">
                    {countryInfos}
                </div>
            </main>
        )
    }
}

